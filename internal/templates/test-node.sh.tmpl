#!/bin/bash

set -euo pipefail

LINES=$(cat <<'EOF'
{{range .TestLines}}{{.Package}} '{{.TestPattern}}'
{{end}}EOF
)

FLAGS="{{.Flags}}"
CWD="$(pwd)"
count=0
commands=()

export PATH="{{.BinariesDir}}:$PATH"

while IFS= read -r line; do
  if [ -z "$line" ]; then
    continue
  fi
  count=$((count + 1))
  report="${CWD}/test-reports/junit-{{.NodeIndex}}-${count}.xml"
  json="{{.JSONDir}}/test-{{.NodeIndex}}-${count}.json"
  pkg="${line%% *}"
  bin="${pkg//\//.}.test"
  runs="${line#$pkg }"

  CMD="cd ${pkg} && gotestsum -f standard-verbose --jsonfile ${json} --packages ${pkg} --rerun-fails --junitfile ${report} --junitfile-testsuite-name relative --junitfile-testcase-classname relative --raw-command -- go tool test2json -t -p ${pkg} ${bin} ${FLAGS} -test.v=test2json -test.run ${runs}"
  echo "$CMD"
  commands+=("$CMD")
done <<< "$LINES"

printf "\"%s\"\n" "${commands[@]}" | xargs -I {} -P {{.Concurrency}} bash -c '{}'

cat {{.JSONDir}}/*.json > {{.JSONDir}}/test-{{.NodeIndex}}.json || true
rm {{.JSONDir}}/test-{{.NodeIndex}}-*.json || true
